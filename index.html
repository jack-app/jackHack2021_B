<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>SocketIOチャット</title>
</head>
<body>

<h1>SocketIOチャット</h1>

<!-- 発言フォーム -->
<form id="frm-post">
  <input type="text" id="msg">
  <button>送信</button>
</form>

<!-- 発言ログ -->
<ul id="msglist">
</ul>

<a href="http://www.goo.ne.jp/">
  <img src="//u.xgoo.jp/img/sgoo.png" alt="supported by goo"
  title="supported by goo" width="100">
</a>

<script src="/socket.io/socket.io.js"></script>
<script>
  //-------------------------------------
  // Socket.ioサーバへ接続
  //-------------------------------------
  const socket = io();
  
  async function morph(str) {
    const appID = "9486ef140a8d2dfa29ad0ae7a6ee39fb5cf73f87aa63611211b74ef38edd5a1b"　//形態素解析API
    let postData = {app_id:appID,sentence:str,info_filter:"form|read"};
    let ans = await fetch('https://labs.goo.ne.jp/api/morph',{
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(postData),
    })
    .then(response => response.json())
    .then(data => data.word_list[0]);
    return ans
  };

  function haikuLength(str) {
    let ary = str.match(/ャ|ュ|ョ/g);
    if (ary == null) {
      return str.length;
    } else {
      return str.length - ary.length;
    };
  };
  //575に分割
  async function parce(str) {
    let ary = await morph(str);
    let kami="",naka="",simo="",kami_y="",naka_y="",simo_y="";

    while (haikuLength(kami_y) < 5 && ary.length >0) {
      let word = ary.shift();
      kami += word[0];
      kami_y += word[1];
    };
    while (haikuLength(naka_y) < 7 && ary.length >0) {
      let word = ary.shift();
      naka += word[0];
      naka_y += word[1];
    };
    while (ary.length >0) {
      let word = ary.shift();
      simo += word[0];
      simo_y += word[1];
    };

    let json = {
      俳句:[
        kami,naka,simo
      ],
      読み:[
        kami_y,naka_y,simo_y
      ]
    };
    console.log(json);
    return json
  };

  /**
   * [イベント] フォームが送信された
   */
  document.querySelector("#frm-post").addEventListener("submit", (e)=>{
    // 規定の送信処理をキャンセル(画面遷移しないなど)
    e.preventDefault();

    // 入力内容を取得する
    const msg = document.querySelector("#msg");
    if( msg.value === "" ){
      return(false);
    }

    // Socket.ioサーバへ送信
    socket.emit("post", {text: parce(msg.value)});

    // 発言フォームを空にする
    msg.value = "";
  });

  /**
   * [イベント] 誰かが発言した
   */
  socket.on("member-post", (msg)=>{
    const list = document.querySelector("#msglist");
    const li = document.createElement("li");
    li.innerHTML = `${msg.text}`;
    list.insertBefore(li, list.firstChild);
  });

  /**
   * [イベント] ページの読込み完了
   */
  window.onload = ()=>{
    // テキストボックスを選択する
    document.querySelector("#msg").focus();
  }
</script>
</body>
</html>
